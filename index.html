
<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credmix - Instituto Mix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" href="imagens/favicon.png" type="imagens/favicon.png">
  <style>
    .gradient-bg {
      background: #a3161d;
    }

    let countdownInterval;

    .card-shadow {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    textarea {
      resize: none;
    }

    @media print {
      body * {
        visibility: hidden;
      }

      #printArea,
      #printArea * {
        visibility: visible !important;
      }

      #printArea {
        position: absolute !important;
        left: 0;
        top: 0;
        width: 100vw;
        min-height: 100vh;
        background: #fff;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
      }
    }

    #copySuccessMsg {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #16a34a;
      color: #fff;
      padding: 14px 32px;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      font-size: 1.1rem;
    }
    
    .logo-canto {
      position: absolute;
      top: 18px;
      right: 24px;
      width: 120px;
      height: auto;
      z-index: 10;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.65);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }

    .modal-content {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.20);
      max-width: 95vw;
      max-height: 90vh;
      width: 500px;
      padding: 0;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.3s;
    }

    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 2rem;
      color: #333;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 10;
      transition: color 0.2s;
    }
    
    input, select {
  border: 1px solid #ccc;
  border-radius: 0.5rem;
  padding: 0.5rem 0.75rem;
  width: 100%;
  outline: none;
  transition: all 0.2s;
}

input:focus, select:focus {
  border-color: #a3161d;
  box-shadow: 0 0 0 3px rgba(163,22,29,0.2);
}


    .modal-close-btn:hover {
      color: #f00;
    }

    .modal-video {
      width: 100%;
      max-width: 480px;
      border-radius: 0 0 1rem 1rem;
      background: #000;
      display: block;
    }

    @media (max-width: 600px) {
      .modal-content {
        width: 98vw;
        max-width: 98vw;
        padding: 0;
      }

      .modal-video {
        width: 100%;
        max-width: 100vw;
        height: auto;
      }
        #blocoAvisoLogo {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}

.logo-canto {
  position: static; /* n√£o absoluta! */
  width: 120px;
  height: auto;
  margin-left: 12px;
  margin-top: 0;
}

/* Responsivo: no mobile, empilha aviso e logo */
@media (max-width: 600px) {
  #blocoAvisoLogo {
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
  }
  .logo-canto {
    width: 90px;
    margin: 0 auto 0 auto;
    display: block;
  }
  #alertaUltimaBolsa {
    margin-top: 0;
    margin-bottom: 4px;
    font-size: 1.05rem;
    text-align: center;
  }
}
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-2 sm:px-4 py-8">
    <div class="max-w-5xl mx-auto">

      <!-- Tela de login -->
      <div id="loginDiv"
        class="bg-white p-8 rounded-xl card-shadow fade-in flex flex-col items-center justify-center min-h-[350px]">
        <div class="flex items-center gap-4 mb-6">
          <p></p> <img src="imagens/grau.png" <p="">
          <p></p>
        </div>
        <div id="loginLoadMsg" class="mb-4 flex items-center gap-2 text-red-600 font-semibold">
          <i class="fas fa-spinner fa-spin"></i>
          Carregando dados de acesso...
        </div>
        <form id="loginForm" onsubmit="event.preventDefault(); tentarLogin();" class="w-full max-w-xs hidden">
          <div class="mb-4">
            <label for="loginUsuario" class="block font-semibold mb-1">Usu√°rio:</label>
            <input type="text" id="loginUsuario" required="" class="w-full border rounded px-3 py-2"
              autocomplete="username">
          </div>
          <div class="mb-4">
            <label for="loginSenha" class="block font-semibold mb-1">Senha:</label>
            <input type="password" id="loginSenha" required="" class="w-full border rounded px-3 py-2"
              autocomplete="current-password">
          </div>
          <button type="submit"
            class="bg-[#a3161d] hover:bg-[#8f1218] text-white font-semibold rounded px-6 py-2 w-full transition-colors duration-200">
            Entrar
          </button>
          <div id="loginErroMsg" class="mt-4 text-red-700 font-semibold hidden"></div>
        </form>
      </div>

      <!-- Modal de v√≠deo -->
      <div id="videoModal" style="display:none;" class="modal-overlay" onclick="fecharModalVideo(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
          <button class="modal-close-btn" onclick="fecharModalVideo(event)" aria-label="Fechar v√≠deo">√ó</button>
          <video id="videoPlayer" class="modal-video" controls="" preload="metadata" poster="" tabindex="0">
            <source id="videoSource" src="" type="video/mp4">
            Seu navegador n√£o suporta v√≠deo HTML5.
          </video>
          <div id="videoTitulo" class="w-full text-center p-2 font-bold text-lg text-gray-700"></div>
        </div>
      </div>
      <!-- Fim do modal -->

      <!-- Conte√∫do principal do sistema (fica escondido at√© login) -->
      <div id="sistemaDiv" class="hidden">
        <div
          class="gradient-bg text-white rounded-t-xl p-6 flex flex-col sm:flex-row items-center justify-between gap-4">
          <div class="flex-1 flex items-center gap-4">
            <img src="imagens/grau.png" alt="Logo Grau Educacional"
              class="h-16 w-auto bg-white rounded-lg p-1 shadow-md">
            <div>
              <h1 class="text-3xl font-bold text-white">Instituto Mix</h1>
              <p class="text-white-100" id="usuarioLogado"></p>
              <nav class="mt-3">
                <ul class="flex flex-wrap gap-6 text-base font-semibold">
                  <li><a href="#" onclick="abrirModalVideo('inicio')"
                      class="transition-colors duration-200 text-white-100 hover:text-yellow-300 hover:underline">Confeitaria</a>
                  </li>
                  <li><a href="#" onclick="abrirModalVideo('cursos')"
                      class="transition-colors duration-200 text-white-100 hover:text-yellow-300 hover:underline">Massagem</a>
                  </li>
                  <li><a href="#" onclick="abrirModalVideo('propostas')"
                      class="transition-colors duration-200 text-white-100 hover:text-yellow-300 hover:underline">Corte e Costura</a>
                  </li>
                  <li><a href="#" onclick="abrirModalVideo('contato')"
                      class="transition-colors duration-200 text-white-100 hover:text-yellow-300 hover:underline">Cabeleleiro
                      stack</a>
                  </li>
                  <li>
                    <button onclick="logoutSistema()" title="Sair" class="ml-2 text-white hover:text-yellow-300">
                      <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
          <div class="hidden sm:flex bg-white text-red-700 p-3 rounded-lg shadow-lg items-center justify-center">
            <i class="fas fa-graduation-cap text-4xl"></i>
          </div>
        </div>
        <div class="bg-white p-8 rounded-b-xl card-shadow fade-in">
          <div id="uploadDiv" class="mb-6">
            <div class="flex items-center gap-2 text-red-700 font-semibold"></div>
            <div class="text-gray-500 text-xs mt-1"></div>
          </div>
          <form id="formDesconto" onsubmit="event.preventDefault(); exibirInfoTurma();">
            <div class="mb-4">
              <label for="numeroCliente">N√∫mero do Cliente:</label>
              <input type="text" id="numeroCliente" placeholder="(00)00000-0000" maxlength="15" class="border rounded w-full p-2" />
            </div>
            <!-- CPF do Cliente abaixo do n√∫mero do cliente -->
            <div class="mb-4">
              <label for="cpfCliente" class="block font-semibold mb-1">CPF do Cliente:</label>
              <input type="text" id="cpfCliente" class="w-full border rounded px-3 py-2"
                placeholder="000.000.000-00" maxlength="14" inputmode="numeric" autocomplete="off">
            </div>
            <div class="mb-4">
              <label for="nomeCliente" class="block font-semibold mb-1">Nome do Cliente:</label>
              <input type="text" id="nomeCliente" class="w-full border rounded px-3 py-2"
                placeholder="Digite o nome do cliente" maxlength="100">
            </div>
            <div class="mb-4 flex items-center gap-3">
              <label for="modalidade" class="block font-semibold mb-1">Modalidade:</label>
              <select id="modalidade" class="border rounded px-3 py-2"></select>
              <span id="iconModalidade"></span>
            </div>
            <div class="mb-4">
              <label for="curso" class="block font-semibold mb-1">Escolha o curso:</label>
              <select id="curso" class="w-full border rounded px-3 py-2"></select>
            </div>
            <div class="mb-4">
              <label for="turno" class="block font-semibold mb-1">Escolha o turno:</label>
              <select id="turno" class="w-full border rounded px-3 py-2"></select>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
              <button type="submit" id="btnTurma"
                class="bg-[#a3161d] hover:bg-[#8f1218] text-white font-semibold rounded px-6 py-2 transition-colors duration-200">
                Consultar Turma
              </button>
              <button type="button" onclick="limparFormulario()"
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded px-6 py-2 transition-colors duration-200 flex items-center gap-2">
                <i class="fas fa-broom"></i> Limpar
              </button>
            </div>
            <div id="resultado" class="mb-4" role="region" aria-live="polite"></div>
            <div id="areaDesconto"></div>
          </form>
          <div id="timer" class="text-center text-red-600 font-semibold mt-6"></div>
        </div>
        <div id="printArea" class="hidden"></div>
      </div>
    </div>
  </div>
  <div id="copySuccessMsg">
    <i class="fas fa-check-circle"></i> Copiado como imagem!
  </div>
  <script>
document.getElementById('numeroCliente').addEventListener('input', function(e) {
  let valor = e.target.value.replace(/\D/g, ''); // remove tudo que n√£o √© n√∫mero
  if (valor.length > 11) valor = valor.slice(0, 11);

  if (valor.length > 6) {
    if (valor.length === 11) {
      // formato (00)00000-0000 ‚Üí celular
      e.target.value = `(${valor.slice(0,2)})${valor.slice(2,7)}-${valor.slice(7)}`;
    } else {
      // formato (00)0000-0000 ‚Üí fixo
      e.target.value = `(${valor.slice(0,2)})${valor.slice(2,6)}-${valor.slice(6)}`;
    }
  } else if (valor.length > 2) {
    e.target.value = `(${valor.slice(0,2)})${valor.slice(2)}`;
  } else if (valor.length > 0) {
    e.target.value = `(${valor}`;
  }
});
    // M√°scara de CPF ao digitar
    document.addEventListener('DOMContentLoaded', function () {
      const cpfInput = document.getElementById('cpfCliente');
      if (cpfInput) {
        cpfInput.addEventListener('input', function (e) {
          let v = cpfInput.value.replace(/\D/g, '');
          if (v.length > 11) v = v.slice(0, 11);
          v = v.replace(/(\d{3})(\d)/, '$1.$2');
          v = v.replace(/(\d{3})(\d)/, '$1.$2');
          v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
          cpfInput.value = v;
        });
      }
    });

    // ==================== MODAL DE V√çDEO ====================
    const videosDoMenu = {
      inicio: { src: "videos/inicio.mp4", titulo: "Apresenta√ß√£o - In√≠cio" },
      cursos: { src: "videos/cursos.mp4", titulo: "Informa√ß√µes sobre Cursos" },
      propostas: { src: "videos/propostas.mp4", titulo: "Como fazer Propostas" },
      contato: { src: "videos/contato.mp4", titulo: "Fale Conosco" }
    };


    function abrirModalVideo(tipo) {
      const modal = document.getElementById('videoModal');
      const player = document.getElementById('videoPlayer');
      const source = document.getElementById('videoSource');
      const titulo = document.getElementById('videoTitulo');
      if (videosDoMenu[tipo]) {
        source.src = videosDoMenu[tipo].src;
        player.load();
        titulo.textContent = videosDoMenu[tipo].titulo;
      } else {
        source.src = "";
        titulo.textContent = "";
      }
      modal.style.display = "flex";
      player.focus();
    }

    function fecharModalVideo(event) {
      const modal = document.getElementById('videoModal');
      const player = document.getElementById('videoPlayer');
      modal.style.display = "none";
      player.pause();
      player.currentTime = 0;
    }
    document.addEventListener('keydown', function (e) {
      if (e.key === "Escape") fecharModalVideo();
    });

    // ====== RESTO DO SISTEMA (SEU JS ORIGINAL, N√ÉO ALTERADO) ======
    let turmasPlanilha = [], precosPlanilha = [], acessosPlanilha = [];
    let planilhaOk = false, countdownInterval;
    let lastResumoTexto = '', lastResumoHTML = '', resumoDataFim = null, resumoInicioTurma = '', resumoDiasAula = '', resumoTurmaDisciplinas = [], resumoModalidade = '';
    let modalidadesDisponiveis = [], cursosDisponiveis = [], turnosDisponiveis = [];
    let usuarioAutenticado = null;

    // ====== CARREGAMENTO DA PLANILHA E DADOS DE ACESSO ======
    const caminhoPlanilha = 'planilhas/turmas_precos.xlsx';

    function carregarPlanilhaLocal() {
      fetch(caminhoPlanilha)
        .then(response => {
          if (!response.ok) throw new Error("Arquivo n√£o encontrado! Verifique se a planilha est√° em 'planilhas/turmas_precos.xlsx'");
          return response.arrayBuffer();
        })
        .then(data => {
          const workbook = XLSX.read(data, { type: 'array' });
          // ----- LEITURA DA ABA ACESSO (com limpeza de espa√ßos extras) -----
          const sheetAcesso = workbook.Sheets['Acesso'];
          if (!sheetAcesso) {
            document.getElementById("loginLoadMsg").innerHTML = "<span class='text-red-700 font-bold'><i class='fas fa-exclamation-triangle'></i> Planilha n√£o cont√©m aba 'Acesso'!</span>";
            return;
          }
          acessosPlanilha = XLSX.utils.sheet_to_json(sheetAcesso, { defval: '' }).map(u => ({
            login: (u.login || '').toString().trim(),
            senha: (u.senha || '').toString().trim(),
            nome: (u.nome || '').toString().trim(),
            cargo: (u.cargo || '').toString().trim()
          }));

          // ---- ABA TURMAS ----
          const sheetTurmas = workbook.Sheets['Turmas'];
          if (!sheetTurmas) {
            document.getElementById("loginLoadMsg").innerHTML = "<span class='text-red-700 font-bold'><i class='fas fa-exclamation-triangle'></i> Planilha n√£o cont√©m aba 'Turmas'!</span>";
            return;
          }
          turmasPlanilha = [];
          const linhasTurmas = XLSX.utils.sheet_to_json(sheetTurmas, { defval: '' });
          linhasTurmas.forEach(linha => {
            let existe = turmasPlanilha.find(t =>
              t.curso === linha.Curso &&
              t.turno === linha.Turno &&
              t.turma === linha.Turma &&
              t.modalidade === linha.Modalidade
            );
            if (!existe) {
              turmasPlanilha.push({
                curso: linha.Curso,
                turno: linha.Turno,
                turma: linha.Turma,
                dias: linha.Dias,
                modalidade: linha.Modalidade,
                disciplinas: []
              });
            }
            existe = turmasPlanilha.find(t =>
              t.curso === linha.Curso &&
              t.turno === linha.Turno &&
              t.turma === linha.Turma &&
              t.modalidade === linha.Modalidade
            );
            if (linha.DisciplinaNome || linha.DataInicio) {
              existe.disciplinas.push({
                inicio: linha.DataInicio,
                nro: linha.DisciplinaNro || '',
                nome: linha.DisciplinaNome || 'In√≠cio da turma'
              });
            }
          });
          // ---- ABA PRECOS ----
          const sheetPrecos = workbook.Sheets['Precos'];
          if (!sheetPrecos) {
            document.getElementById("loginLoadMsg").innerHTML = "<span class='text-red-700 font-bold'><i class='fas fa-exclamation-triangle'></i> Planilha n√£o cont√©m aba 'Precos'!</span>";
            return;
          }
          precosPlanilha = XLSX.utils.sheet_to_json(sheetPrecos, { defval: '' });
          modalidadesDisponiveis = [...new Set(turmasPlanilha.map(t => t.modalidade))];
          planilhaOk = true;
          // Libera tela de login
          document.getElementById("loginLoadMsg").style.display = "none";
          document.getElementById("loginForm").classList.remove("hidden");
        })
        .catch(err => {
          document.getElementById("loginLoadMsg").innerHTML = "<span class='text-red-700 font-bold'><i class='fas fa-exclamation-triangle'></i> Erro ao carregar a planilha: " + err.message + "</span>";
        });
    }

    window.onload = carregarPlanilhaLocal;

    // ====== AUTENTICA√á√ÉO ======
    function tentarLogin() {
      const usuario = document.getElementById('loginUsuario').value.trim();
      const senha = document.getElementById('loginSenha').value.trim();
      const erroMsg = document.getElementById('loginErroMsg');
      erroMsg.classList.add("hidden");
      let user = acessosPlanilha.find(u =>
        u.login.toLowerCase() === usuario.toLowerCase() && u.senha === senha
      );
      if (!user) {
        erroMsg.textContent = "Usu√°rio ou senha inv√°lidos.";
        erroMsg.classList.remove("hidden");
        return;
      }
      usuarioAutenticado = user;
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("sistemaDiv").classList.remove("hidden");
      document.getElementById("usuarioLogado").innerHTML = `<span class="font-semibold">Bem-vindo(a), ${user.nome}!</span> <span class="text-sm">[${user.cargo}]</span>`;
      preencherModalidades();
      limparFormulario();
    }
    function logoutSistema() {
      usuarioAutenticado = null;
      document.getElementById("sistemaDiv").classList.add("hidden");
      document.getElementById("loginDiv").style.display = "";
      document.getElementById("loginForm").reset();
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("loginErroMsg").classList.add("hidden");
    }

    // ====== RESTANTE DO SISTEMA ======
    function excelDateToString(excelDate) {
      if (!excelDate) return '-';
      if (typeof excelDate === "string" && excelDate.match(/^\d{4}-\d{2}-\d{2}/)) {
        const [y, m, d] = excelDate.split('-');
        return `${d}/${m}/${y}`;
      }
      if (typeof excelDate === "number") {
        const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
        const d = String(date.getUTCDate()).padStart(2, '0');
        const m = String(date.getUTCMonth() + 1).padStart(2, '0');
        const y = date.getUTCFullYear();
        return `${d}/${m}/${y}`;
      }
      return excelDate;
    }
    function stringToDate_ddmmyyyy(str) {
      if (!str || str === '-') return null;
      const [d, m, y] = str.split('/');
      return new Date(y, m - 1, d, 0, 0, 0, 0);
    }
    function getProximaDataFuturaDisciplinas(disciplinas) {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      let datasFuturas = disciplinas
        .map(d => excelDateToString(d.inicio))
        .map(str => ({ str, date: stringToDate_ddmmyyyy(str) }))
        .filter(obj => obj.date && obj.date >= hoje)
        .sort((a, b) => a.date - b.date);
      return datasFuturas.length > 0 ? datasFuturas[0].str : '';
    }
    function preencherModalidades() {
      const modalidadeSel = document.getElementById('modalidade');
      modalidadeSel.innerHTML = '';
      modalidadesDisponiveis.forEach(modalidade => {
        const option = document.createElement('option');
        option.value = modalidade;
        option.textContent = modalidade;
        modalidadeSel.appendChild(option);
      });
      atualizarIconModalidade();
      modalidadeSel.onchange = function () {
        atualizarIconModalidade();
        preencherCursos();
      }
      preencherCursos();
    }
    function preencherCursos() {
      const modalidade = document.getElementById('modalidade').value;
      const cursoSel = document.getElementById('curso');
      const cursos = turmasPlanilha.filter(t => t.modalidade === modalidade).map(t => t.curso);
      cursosDisponiveis = [...new Set(cursos)];
      cursoSel.innerHTML = '';
      cursosDisponiveis.forEach(curso => {
        const option = document.createElement('option');
        option.value = curso;
        option.textContent = curso;
        cursoSel.appendChild(option);
      });
      cursoSel.onchange = preencherTurnos;
      preencherTurnos();
    }
    function preencherTurnos() {
      const modalidade = document.getElementById('modalidade').value;
      const curso = document.getElementById('curso').value;
      const turnoSel = document.getElementById('turno');
      const turnos = turmasPlanilha.filter(t => t.modalidade === modalidade && t.curso === curso).map(t => t.turno);
      turnosDisponiveis = [...new Set(turnos)];
      turnoSel.innerHTML = '';
      turnosDisponiveis.forEach(turno => {
        const option = document.createElement('option');
        option.value = turno;
        option.textContent = turno;
        turnoSel.appendChild(option);
      });
    }
    function atualizarIconModalidade() {
      const modalidade = document.getElementById('modalidade').value || "";
      const iconSpan = document.getElementById('iconModalidade');
      if (modalidade.toLowerCase().includes('presencial')) {
        iconSpan.innerHTML = '<i class="fas fa-users text-red-600" title="Presencial"></i>';
      } else if (modalidade.toLowerCase().includes('interativo')) {
        iconSpan.innerHTML = '<i class="fas fa-laptop text-red-700" title="Interativo"></i>';
      } else {
        iconSpan.innerHTML = '';
      }
    }
    function exibirInfoTurma() {
      if (!planilhaOk) {
        document.getElementById("resultado").innerHTML = `
          <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            Carregue uma planilha v√°lida antes de consultar turmas.
          </div>`;
        return;
      }
      document.getElementById("resultado").innerHTML = `
    <div class="flex items-center gap-2 text-red-600 font-semibold">
      <i class="fas fa-spinner fa-spin"></i>
      Consultando turma...
    </div>
  `;
      document.getElementById("areaDesconto").innerHTML = "";
      setTimeout(() => {
        mostrarInfoTurma();
      }, 5000);
    }
    function mostrarInfoTurma() {
      const numeroClienteRaw = document.getElementById("numeroCliente").value.trim();
      const numeroCliente = numeroClienteRaw.replace(/\D/g, ''); // remove m√°scara
      const cpfCliente = document.getElementById("cpfCliente").value.trim();
      const nomeCliente = document.getElementById("nomeCliente").value.trim();
      const turnoSelecionado = document.getElementById("turno").value;
      const cursoSelecionado = document.getElementById("curso").value;
      const modalidadeSelecionada = document.getElementById('modalidade').value;
      const resultadoDiv = document.getElementById("resultado");
      const areaDesconto = document.getElementById("areaDesconto");
      resultadoDiv.innerHTML = "";
      document.getElementById("timer").innerHTML = "";
      clearInterval(countdownInterval);

      if (!numeroCliente || !cpfCliente || !nomeCliente) {
        resultadoDiv.innerHTML = `
      <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        Por favor, preencha todos os campos obrigat√≥rios.
      </div>`;
        return;
      }
      if (numeroCliente.length < 10 || numeroCliente.length > 11) {
    resultadoDiv.innerHTML = `
      <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        Informe um n√∫mero de telefone v√°lido (com DDD).
      </div>`;
    return;
  }
      // Valida√ß√£o simples do CPF (opcional, pode melhorar)
      if (!/^\d{3}\.\d{3}\.\d{3}-\d{2}$/.test(cpfCliente)) {
        resultadoDiv.innerHTML = `
      <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        CPF informado n√£o est√° no formato correto.
      </div>`;
        return;
      }

      const turmaInfo = turmasPlanilha.find(item =>
        item.curso === cursoSelecionado &&
        item.turno === turnoSelecionado &&
        item.modalidade === modalidadeSelecionada
      );

      if (!turmaInfo) {
        resultadoDiv.innerHTML = `
      <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        N√£o h√° turma dispon√≠vel para essa combina√ß√£o de curso, turno e modalidade.
      </div>`;
        return;
      }

      resumoTurmaDisciplinas = turmaInfo.disciplinas;
      resumoInicioTurma = getProximaDataFuturaDisciplinas(resumoTurmaDisciplinas);
      resumoDiasAula = turmaInfo.dias;
      resumoModalidade = turmaInfo.modalidade;

      let blocoInicio = "";
      let blocoDisciplinas = "";
      if (!resumoModalidade.toLowerCase().includes('interativo')) {
        blocoInicio = `<b>In√≠cio da turma:</b> ${resumoInicioTurma ? resumoInicioTurma : '-'} <br>`;
        blocoDisciplinas = `<b>Cronograma de disciplinas:</b> <table class="w-full mt-3 text-sm">
        <thead>
            <tr class="bg-blue-50">
                <th class="py-2 px-2 text-left font-bold">In√≠cio</th>
                <th class="py-2 px-2 text-left font-bold">Disciplina</th>
            </tr>
        </thead>
        <tbody>
            ${turmaInfo.disciplinas.map(d => `
            <tr>
                <td class="py-1 px-2">${excelDateToString(d.inicio)}</td>
                <td class="py-1 px-2">${d.nro ? d.nro + ' - ' : ''}${d.nome}</td>
            </tr>
            `).join('')}
        </tbody>
      </table>`;
      }

      resultadoDiv.innerHTML = `
    <div class="flex items-center gap-2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded font-semibold" role="status">
      <i class="fas fa-check-circle"></i>
      Informa√ß√µes da turma localizada!
    </div>
    <div class="mt-3">
      <strong>Informa√ß√µes da turma:</strong><br>
      <b>Turma:</b> ${turmaInfo.turma} <br>
      <b>Modalidade:</b> ${resumoModalidade} <br>
      ${blocoInicio}
      <b>Dias de aula:</b> ${resumoDiasAula} <br>
      ${blocoDisciplinas}
    </div>
  `;

      areaDesconto.innerHTML = `
    <div class="mt-4">
      <label for="desconto" class="font-semibold mb-1 block">Escolha o desconto:</label>
      <select id="desconto" onchange="mostrarCampoSenha()" class="w-full border rounded px-3 py-2 mb-2">
        <option value="30">Padr√£o</option>
        <option value="35">Coordenador</option>
        <option value="40">Diretora</option>
      </select>
    </div>
    <div id="senhaContainer" style="display:none;" class="mt-2">
      <label for="senhaCoordenador" class="font-semibold mb-1 block">Senha do Coordenador:</label>
      <input type="password" id="senhaCoordenador" class="w-full border rounded px-3 py-2" placeholder="Digite a senha do coordenador" />
    </div>
    <button type="button" class="bg-[#a3161d] hover:bg-[#8f1218] text-white font-semibold rounded px-6 py-2 w-full mt-4 transition-colors duration-200" onclick="mostrarDelayBolsa()">Gerar Bolsa de Desconto</button>
  `;
    }
    function mostrarCampoSenha() {
      const descontoSelecionado = document.getElementById("desconto").value;
      const senhaDiv = document.getElementById("senhaContainer");
      if (descontoSelecionado === "35" || descontoSelecionado === "40") {
        senhaDiv.style.display = "block";
      } else {
        senhaDiv.style.display = "none";
      }
    }
    function mostrarDelayBolsa() {
      const descontoSelect = document.getElementById("desconto");
      const descontoValor = descontoSelect ? descontoSelect.value : "10";
      const senhaCoordenadorInput = document.getElementById("senhaCoordenador");
      const senhaValor = senhaCoordenadorInput ? senhaCoordenadorInput.value : "";
      const resultadoDiv = document.getElementById("resultado");
      const areaDesconto = document.getElementById("areaDesconto");
      areaDesconto.innerHTML = "";
      resultadoDiv.innerHTML = `
        <div class="flex items-center gap-2 text-red-600 font-semibold mt-2">
          <i class="fas fa-spinner fa-spin"></i>
          Conectando aos servidores...
        </div>
      `;
      setTimeout(() => {
        resultadoDiv.innerHTML = resultadoDiv.innerHTML.replace(/<div class="flex items-center gap-2 text-red-600 font-semibold mt-2">[\s\S]*?<\/div>/, "");
        gerarBolsaDesconto(descontoValor, senhaValor);
      }, 7000);
    }

    function gerarBolsaDesconto(descontoStr, senhaCoordenador) {
      const numeroCliente = document.getElementById("numeroCliente").value.trim();
      const cpfCliente = document.getElementById("cpfCliente").value.trim();
      const nomeCliente = document.getElementById("nomeCliente").value.trim();
      const turnoSelecionado = document.getElementById("turno").value;
      const cursoSelecionado = document.getElementById("curso").value;
      const modalidadeSelecionada = document.getElementById('modalidade').value;
      const desconto = parseFloat(descontoStr) / 100;
      const resultadoDiv = document.getElementById("resultado");
      const areaDesconto = document.getElementById("areaDesconto");

      const precoObj = precosPlanilha.find(p =>
        p.Curso === cursoSelecionado && p.Turno === turnoSelecionado && (p.Modalidade ? p.Modalidade === modalidadeSelecionada : true)
      );
      if (!precoObj) {
        resultadoDiv.innerHTML += `
      <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-2" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        N√£o foi encontrado pre√ßo para este curso/turno/modalidade na aba Precos!
      </div>`;
        areaDesconto.innerHTML = "";
        return;
      }
      const precoCheio = Number(precoObj.ValorCheio) || 0;
      const parcelas = Number(precoObj.Parcelas) || 1;
      const valorFinal = precoCheio * (1 - desconto);
      const valorParcela = valorFinal / parcelas;

      if ((descontoStr === "35" || descontoStr === "40") && senhaCoordenador !== "7309") {
        resultadoDiv.innerHTML += `
      <div class="flex items-center gap-2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-2" role="alert">
        <i class="fas fa-lock"></i>
        Senha do Coordenador incorreta.
      </div>`;
        areaDesconto.innerHTML = "";
        return;
      }

      const agora = new Date();
      const dataFim = new Date(agora.getTime() + 6 * 60 * 60 * 1000); // 6 horas
      resumoDataFim = dataFim;

      function formatarDataHoraBR(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${d}/${m}/${y} √†s ${h}:${min}`;
      }
      const dataEncerramentoBR = formatarDataHoraBR(dataFim);

      let proximoInicio = getProximaDataFuturaDisciplinas(resumoTurmaDisciplinas);
      let linhaInicioTurmaTexto = '';
      let linhaInicioTurmaHTML = '';
      if (!resumoModalidade.toLowerCase().includes('interativo')) {
        if (proximoInicio) {
          linhaInicioTurmaTexto = `In√≠cio da turma: ${proximoInicio}\n`;
          linhaInicioTurmaHTML = `<b>In√≠cio da turma:</b> ${proximoInicio} <br>`;
        }
      }

      let iconeModalidade = '';
      if (resumoModalidade.toLowerCase().includes('presencial')) {
        iconeModalidade = '<i class="fas fa-users text-green-600" title="Presencial"></i> ';
      } else if (resumoModalidade.toLowerCase().includes('interativo')) {
        iconeModalidade = '<i class="fas fa-laptop text-blue-700" title="Interativo"></i> ';
      }

      // INCLUIR CPF NO RESUMO (texto e html)
      const resumoTexto = `
Cliente: ${nomeCliente}
N¬∫ Cliente: ${numeroCliente}
CPF: ${cpfCliente}
Curso: ${cursoSelecionado}
Turno: ${turnoSelecionado}
Modalidade: ${resumoModalidade}
${linhaInicioTurmaTexto}Dias de aula: ${resumoDiasAula}
Valor cheio: R$ ${precoCheio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
Desconto: ${descontoStr}%
Valor com desconto: R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
Parcelas: ${parcelas}x de R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
${usuarioAutenticado ? usuarioAutenticado.cargo + ': ' + usuarioAutenticado.nome : ''}
Proposta v√°lida at√©: ${dataEncerramentoBR}
  `;

      let blocoDisciplinas = '';
      if (!resumoModalidade.toLowerCase().includes('interativo')) {
        blocoDisciplinas = `<div class="mb-2"><b>Cronograma de disciplinas:</b>
      <table class="w-full mt-1 text-sm">
        <thead>
            <tr class="bg-blue-50">
                <th class="py-2 px-2 text-left font-bold">In√≠cio</th>
                <th class="py-2 px-2 text-left font-bold">Disciplina</th>
            </tr>
        </thead>
        <tbody>
            ${resumoTurmaDisciplinas.map(d => `
            <tr>
                <td class="py-1 px-2">${excelDateToString(d.inicio)}</td>
                <td class="py-1 px-2">${d.nro ? d.nro + ' - ' : ''}${d.nome}</td>
            </tr>
            `).join('')}
        </tbody>
      </table></div>`;
      }

     // AVISO √öLTIMA BOLSA DENTRO DA IMAGEM, ACIMA DO RESUMO
let alertaUltimaBolsaHTML = '';
if (descontoStr === "35") {
  alertaUltimaBolsaHTML = `
    <div id="alertaUltimaBolsa" class="inline-block bg-yellow-300 border-l-4 border-yellow-500 text-red-800 p-3 mb-4 rounded-lg shadow-md font-bold text-center text-lg">
      üö® AVISO: √öLTIMA BOLSA DISPON√çVEL! üö®
    </div>
  `;
}

// CPF exibido logo ap√≥s n√∫mero do cliente
const resumoHTML = `
  <div id="areaParaCopiarImagem" class="mt-6 bg-yellow-100 border border-yellow-200 rounded-lg p-6 text-black relative fade-in">
    <div id="blocoAvisoLogo" class="flex items-start justify-between relative mb-2">
    <div class="flex-1">
    ${alertaUltimaBolsaHTML}
    </div>
    <img src="imagens/grau.png" class="logo-canto" alt="Logo">
    </div>
    <h2 class="text-2xl font-bold mb-2">Resumo da Proposta</h2>
    <div class="mb-2"><b>Cliente:</b> ${nomeCliente} <br>
      <b>N¬∫ Cliente:</b> ${numeroCliente} <br>
      <b>CPF:</b> ${cpfCliente} <br>
      <b>Curso:</b> ${cursoSelecionado} <br>
      <b>Turno:</b> ${turnoSelecionado} <br>
      <b>Modalidade:</b> ${iconeModalidade}${resumoModalidade} <br>
      ${linhaInicioTurmaHTML}
      <b>Dias de aula:</b> ${resumoDiasAula}
    </div>
    ${blocoDisciplinas}
    <div class="mb-2">
      <b>Valor cheio:</b> <span class="line-through text-red-600">R$ ${precoCheio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span><br>
      <b>Desconto:</b> <span class="text-green-700 font-bold">${descontoStr}%</span><br>
      <b>Valor com desconto:</b> <span class="text-green-600 font-bold text-xl">R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span><br>
      <b>Parcelamento:</b> <span class="text-green-700">${parcelas}x</span> de <span class="text-green-700 font-bold">R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
    </div>
    <div class="mb-2">
      <span style="font-weight:bold; color:#444; display:inline-block; margin-top:12px;">
        ${usuarioAutenticado ? usuarioAutenticado.cargo + ': ' + usuarioAutenticado.nome : ''}
      </span>
      <b>Proposta v√°lida at√©:</b> <span class="text-red-700 font-bold">${dataEncerramentoBR}</span>
    </div>
    <div class="mt-3 flex flex-col sm:flex-row gap-2">
      <button type="button" onclick="copiarResumoComoImagem()" class="bg-green-600 hover:bg-green-700 text-white font-semibold rounded px-4 py-2 w-full sm:w-auto transition-colors duration-200">
        <i class="fas fa-copy"></i> Copiar imagem do resumo
      </button>
      <button onclick="matricular()" class="bg-red-700 text-white px-4 py-2 rounded">
  Matricular
</button>
    </div>
    <div class="text-xs text-yellow-600 mt-2">*Proposta v√°lida por tempo limitado. V√°lida somente para o cliente informado.</div>
  </div>
`;

      lastResumoTexto = resumoTexto;
      lastResumoHTML = resumoHTML;
      iniciarTimer(6 * 60 * 60);
      resultadoDiv.innerHTML += resumoHTML;
    }

    async function copiarResumoComoImagem() {
      const area = document.getElementById('areaParaCopiarImagem');
      if (!area) return;
      const btns = area.querySelectorAll('button');
      btns.forEach(b => b.style.visibility = 'hidden');
      try {
        const canvas = await html2canvas(area, { backgroundColor: null, scale: window.devicePixelRatio, useCORS: true });
        canvas.toBlob(async function (blob) {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob })
            ]);
            showCopySuccessMsg();
          } catch (err) {
            alert("N√£o foi poss√≠vel copiar a imagem. D√™ permiss√£o ao navegador e tente novamente.");
          }
        }, 'image/png');
      } catch (e) {
        alert('Erro ao copiar imagem: ' + e);
      } finally {
        btns.forEach(b => b.style.visibility = '');
      }
    }

    function showCopySuccessMsg() {
      const msg = document.getElementById('copySuccessMsg');
      if (!msg) return;
      msg.style.display = "block";
      setTimeout(() => {
        msg.style.display = "none";
      }, 2000);
    }

    function iniciarTimer(segundos) {
  const timerDiv = document.getElementById("timer");
  timerDiv.style.display = "block"; // <-- Mostra o timer
  let tempoRestante = segundos;
  clearInterval(countdownInterval);
  atualizarTimer();
  countdownInterval = setInterval(() => {
    tempoRestante--;
    atualizarTimer();
    if (tempoRestante <= 0) {
      clearInterval(countdownInterval);
      timerDiv.innerHTML = `<i class="fas fa-hourglass-end"></i> Proposta expirada! Gere novamente para continuar.`;
      document.getElementById("resultado").innerHTML = "";
      document.getElementById("areaDesconto").innerHTML = "";
      const alerta = document.getElementById("alertaUltimaBolsa");
      if (alerta) alerta.style.display = "none";
    }
  }, 1000);
      function atualizarTimer() {
        const min = Math.floor(tempoRestante / 60);
        const sec = tempoRestante % 60;
        const h = Math.floor(min / 60);
        const m = min % 60;
        let label = `<i class="fas fa-clock"></i> Tempo restante da proposta: <span class="font-bold">${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}</span>`;
        if (resumoDataFim) {
          label += `<br><span class="text-xs text-gray-500">Encerramento: ${String(resumoDataFim.getDate()).padStart(2, '0')}/${String(resumoDataFim.getMonth() + 1).padStart(2, '0')}/${resumoDataFim.getFullYear()} √†s ${String(resumoDataFim.getHours()).padStart(2, '0')}:${String(resumoDataFim.getMinutes()).padStart(2, '0')}</span>`;
        }
        timerDiv.innerHTML = label;
      }
    }
    async function matricular() {
  const dados = {
    curso: document.getElementById("curso").value,
    turno: document.getElementById("turno").value,
    dia: document.getElementById("dia").value,
    nome: document.getElementById("nomeCliente").value,
    cpf: document.getElementById("cpfCliente").value,
    numero: document.getElementById("numeroCliente").value,
    parcelas: document.getElementById("parcelas").value,
    desconto: document.getElementById("desconto").value,
    valorParcela: document.getElementById("valorParcela").value
  };

  const response = await fetch("/.netlify/functions/gerar-matricula", {
    method: "POST",
    body: JSON.stringify(dados)
  });

  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `PRE_${dados.nome.replace(/\s+/g, "_")}.xlsx`;
  a.click();
    }
    function limparFormulario() {
  document.getElementById("formDesconto").reset();
  document.getElementById("resultado").innerHTML = "";
  document.getElementById("areaDesconto").innerHTML = "";
  const alerta = document.getElementById("alertaUltimaBolsa");
  if (alerta) alerta.style.display = "none";

  // üîπ Para e esconde o timer
  clearInterval(countdownInterval);
  const timerDiv = document.getElementById("timer");
  timerDiv.innerHTML = "";
  timerDiv.style.display = "none";

  // üîπ Zera vari√°veis do resumo
  resumoDataFim = null;
  resumoInicioTurma = "";
  resumoDiasAula = "";
  resumoTurmaDisciplinas = [];
  resumoModalidade = "";
}

  </script>
</body>
</html>
